name: CD

on:
  push:
    branches: [main, develop]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment'
        required: true
        default: 'staging'
        type: choice
        options: [staging, production]
      version:
        description: 'Image tag (optional)'
        required: false
        type: string

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}/gateway-service
  SERVICE_NAME: gateway-service
  SERVICE_PORT: '3000'
  HELM_CHART_PATH: infrastructure-service/02-kubernetes/services/gateway-service
  STAGING_NAMESPACE: ecommerce-staging
  PRODUCTION_NAMESPACE: ecommerce-production

jobs:
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/develop' || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'staging')
    environment:
      name: staging
      url: https://staging-api.example.com

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure OCI CLI
        uses: oracle-actions/setup-oci-cli@v1
        with:
          config-file-content: ${{ secrets.OCI_CONFIG }}
          fingerprint: ${{ secrets.OCI_FINGERPRINT }}
          apikey: ${{ secrets.OCI_API_KEY }}
          pass-phrase: ${{ secrets.OCI_PASSPHRASE }}
          region: ${{ secrets.OCI_REGION }}
          tenancy: ${{ secrets.OCI_TENANCY }}

      - name: Deploy to Kubernetes (Staging)
        run: |
          echo "Deploying gateway-service to staging..."
          # Add your Kubernetes deployment commands here
          # Example: kubectl set image deployment/gateway-service gateway-service=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:develop

  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'production')
    environment:
      name: production
      url: https://api.example.com

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure OCI CLI
        uses: oracle-actions/setup-oci-cli@v1
        with:
          config-file-content: ${{ secrets.OCI_CONFIG }}
          fingerprint: ${{ secrets.OCI_FINGERPRINT }}
          apikey: ${{ secrets.OCI_API_KEY }}
          pass-phrase: ${{ secrets.OCI_PASSPHRASE }}
          region: ${{ secrets.OCI_REGION }}
          tenancy: ${{ secrets.OCI_TENANCY }}

      - name: Deploy to Kubernetes (Production)
        run: |
          echo "Deploying gateway-service to production..."
          # Add your Kubernetes deployment commands here
          # Example: kubectl set image deployment/gateway-service gateway-service=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:main

