.PHONY: help install build dev test lint format clean clean:all clean:docker setup setup:local migrate migrate:dev migrate:reset migrate:status seed studio docker-build docker-up docker-down docker-logs docker-restart docker-clean docker:setup

help: ## Show this help message
	@echo 'Usage: make [target]'
	@echo ''
	@echo 'Available targets:'
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | awk 'BEGIN {FS = ":.*?## "}; {printf "  %-25s %s\n", $$1, $$2}'

# ============================================================================
# INSTALLATION & SETUP
# ============================================================================

install: ## Install all dependencies
	@echo "ğŸ“¦ Installing dependencies..."
	npm install
	@echo "âœ… Dependencies installed"

setup: ## Complete local setup (install, generate, migrate)
	@echo "ğŸš€ Starting complete setup..."
	@echo "ğŸ“¦ Step 1/4: Installing dependencies..."
	make install
	@echo "ğŸ”§ Step 2/4: Generating Prisma Client..."
	npm run prisma:generate
	@echo "ğŸ—„ï¸  Step 3/4: Running database migrations..."
	make migrate
	@echo "âœ… Step 4/4: Setup complete!"
	@echo ""
	@echo "ğŸ“ Next steps:"
	@echo "   1. Copy .env.example to .env and configure it"
	@echo "   2. Ensure PostgreSQL is running"
	@echo "   3. Run 'make dev' to start development server"

setup:local: ## Setup for local development (with .env check)
	@echo "ğŸš€ Setting up local development environment..."
	@if [ ! -f .env ]; then \
		echo "âš ï¸  .env file not found. Creating from .env.example..."; \
		cp .env.example .env; \
		echo "âœ… .env file created. Please edit it with your configuration."; \
	fi
	@echo "ğŸ“¦ Installing dependencies..."
	make install
	@echo "ğŸ”§ Generating Prisma Client..."
	npm run prisma:generate
	@echo "ğŸ—„ï¸  Running database migrations..."
	make migrate
	@echo "âœ… Local development setup complete!"
	@echo ""
	@echo "ğŸ“ To start development:"
	@echo "   make dev"

# ============================================================================
# DEVELOPMENT
# ============================================================================

dev: ## Start development server with hot reload
	@echo "ğŸš€ Starting development server..."
	npm run dev

build: ## Build the service for production
	@echo "ğŸ”¨ Building service..."
	npm run prisma:generate || true
	npm run build
	@echo "âœ… Build complete"

# ============================================================================
# DATABASE MIGRATIONS
# ============================================================================

migrate: ## Run database migrations (deploy - for production)
	@echo "ğŸ—„ï¸  Running database migrations..."
	npm run prisma:generate
	npm run prisma:migrate:deploy
	@echo "âœ… Migrations applied"

migrate:dev: ## Create new migration (development)
	@echo "ğŸ—„ï¸  Creating new migration..."
	@read -p "Migration name: " name; \
	npm run prisma:migrate dev --name $$name

migrate:reset: ## Reset database (WARNING: Deletes all data)
	@echo "âš ï¸  WARNING: This will delete all data!"
	@read -p "Are you sure? Type 'yes' to continue: " confirm; \
	if [ "$$confirm" = "yes" ]; then \
		npm run prisma:migrate reset; \
		echo "âœ… Database reset complete"; \
	else \
		echo "âŒ Reset cancelled"; \
	fi

migrate:status: ## Check migration status
	@echo "ğŸ“Š Checking migration status..."
	npm run prisma:migrate status

# ============================================================================
# DATABASE UTILITIES
# ============================================================================

seed: ## Seed database with sample data
	@echo "ğŸŒ± Seeding database..."
	npm run seed || echo "âš ï¸  No seed script available"

studio: ## Open Prisma Studio (Database GUI)
	@echo "ğŸ¨ Opening Prisma Studio..."
	npm run prisma:studio

# ============================================================================
# TESTING
# ============================================================================

test: ## Run all tests
	@echo "ğŸ§ª Running all tests..."
	npm test

test:unit: ## Run unit tests only
	@echo "ğŸ§ª Running unit tests..."
	npm run test:unit

test:integration: ## Run integration tests only
	@echo "ğŸ§ª Running integration tests..."
	npm run test:integration

test:e2e: ## Run e2e tests only
	@echo "ğŸ§ª Running e2e tests..."
	npm run test:e2e

test:watch: ## Run tests in watch mode
	@echo "ğŸ§ª Running tests in watch mode..."
	npm run test:watch

test:coverage: ## Run tests with coverage report
	@echo "ğŸ§ª Running tests with coverage..."
	npm run test:coverage

# ============================================================================
# CODE QUALITY
# ============================================================================

lint: ## Lint code with ESLint
	@echo "ğŸ” Linting code..."
	npm run lint

lint:fix: ## Fix linting issues automatically
	@echo "ğŸ”§ Fixing linting issues..."
	npm run lint:fix

format: ## Format code with Prettier
	@echo "ğŸ’… Formatting code..."
	npx prettier --write "**/*.{ts,js,json,md}" || echo "âš ï¸  Prettier not installed"

# ============================================================================
# CLEANING
# ============================================================================

clean: ## Clean build artifacts (dist, coverage, Prisma cache)
	@echo "ğŸ§¹ Cleaning build artifacts..."
	rm -rf dist
	rm -rf node_modules/.prisma
	rm -rf coverage
	rm -rf .jest
	@echo "âœ… Clean complete"

clean:all: ## Clean everything including node_modules (WARNING: Requires reinstall)
	@echo "ğŸ§¹ Cleaning everything..."
	rm -rf dist
	rm -rf node_modules/.prisma
	rm -rf coverage
	rm -rf .jest
	rm -rf node_modules
	@echo "âœ… Everything cleaned. Run 'make install' to reinstall dependencies."

clean:docker: ## Clean Docker containers, volumes, and images
	@echo "ğŸ§¹ Cleaning Docker resources..."
	docker-compose down -v
	@echo "âœ… Docker resources cleaned"

clean:logs: ## Clean log files
	@echo "ğŸ§¹ Cleaning log files..."
	find . -name "*.log" -type f -delete
	rm -rf logs
	@echo "âœ… Log files cleaned"

# ============================================================================
# DOCKER COMMANDS
# ============================================================================

docker-build: ## Build Docker image
	@echo "ğŸ³ Building Docker image..."
	docker-compose build payment-service
	@echo "âœ… Docker image built"

docker-up: ## Start services with docker-compose
	@echo "ğŸ³ Starting Docker services..."
	docker-compose up -d
	@echo "âœ… Services started. Run 'make docker-logs' to view logs."

docker-down: ## Stop docker-compose services
	@echo "ğŸ³ Stopping Docker services..."
	docker-compose down
	@echo "âœ… Services stopped"

docker-logs: ## View docker-compose logs (follow mode)
	@echo "ğŸ“‹ Viewing Docker logs (Ctrl+C to exit)..."
	docker-compose logs -f

docker-restart: ## Restart docker-compose services
	@echo "ğŸ”„ Restarting Docker services..."
	docker-compose restart
	@echo "âœ… Services restarted"

docker-clean: ## Stop and remove containers, volumes (WARNING: Deletes data)
	@echo "âš ï¸  WARNING: This will delete all Docker volumes and data!"
	@read -p "Are you sure? Type 'yes' to continue: " confirm; \
	if [ "$$confirm" = "yes" ]; then \
		docker-compose down -v; \
		echo "âœ… Docker resources cleaned"; \
	else \
		echo "âŒ Clean cancelled"; \
	fi

docker:setup: ## Complete Docker setup (build, up, wait, migrate)
	@echo "ğŸ³ Starting complete Docker setup..."
	@echo "ğŸ“¦ Step 1/5: Building Docker image..."
	make docker-build
	@echo "ğŸš€ Step 2/5: Starting services..."
	make docker-up
	@echo "â³ Step 3/5: Waiting for services to be ready..."
	@sleep 10
	@echo "ğŸ—„ï¸  Step 4/5: Running database migrations..."
	@docker-compose exec -T payment-service npm run prisma:migrate:deploy || echo "âš ï¸  Migration failed - check logs"
	@echo "âœ… Step 5/5: Docker setup complete!"
	@echo ""
	@echo "ğŸ“ Services are running:"
	@echo "   - Payment Service: http://localhost:3005"
	@echo "   - PostgreSQL: localhost:5435"
	@echo "   - Redis: localhost:6385"

# ============================================================================
# UTILITY COMMANDS
# ============================================================================

prisma:generate: ## Generate Prisma Client
	@echo "ğŸ”§ Generating Prisma Client..."
	npm run prisma:generate
	@echo "âœ… Prisma Client generated"

prisma:studio: ## Open Prisma Studio
	@echo "ğŸ¨ Opening Prisma Studio..."
	npm run prisma:studio

status: ## Show project status
	@echo "ğŸ“Š Project Status"
	@echo "=================="
	@echo "Node version: $$(node --version)"
	@echo "NPM version: $$(npm --version)"
	@echo ""
	@if [ -f .env ]; then \
		echo "âœ… .env file exists"; \
	else \
		echo "âš ï¸  .env file not found (run 'make setup:local')"; \
	fi
	@if [ -d node_modules ]; then \
		echo "âœ… Dependencies installed"; \
	else \
		echo "âš ï¸  Dependencies not installed (run 'make install')"; \
	fi
	@if [ -d dist ]; then \
		echo "âœ… Build artifacts exist"; \
	else \
		echo "â„¹ï¸  Not built yet (run 'make build')"; \
	fi

