name: CD

on:
  push:
    branches: [main, develop]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment'
        required: true
        default: 'staging'
        type: choice
        options: [staging, production]
      version:
        description: 'Image tag (optional)'
        required: false
        type: string

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}/shipping-service
  SERVICE_NAME: shipping-service
  SERVICE_PORT: '3009'
  HELM_CHART_PATH: infrastructure-service/02-kubernetes/services/shipping-service
  STAGING_NAMESPACE: ecommerce-staging
  PRODUCTION_NAMESPACE: ecommerce-production

jobs:
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/develop' || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'staging')
    environment:
      name: staging
      url: https://staging-api.example.com

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure OCI CLI
        uses: oracle-actions/setup-oci-cli@v1
        with:
          config-file-content: ${{ secrets.OCI_CONFIG }}
          fingerprint: ${{ secrets.OCI_FINGERPRINT }}
          apikey: ${{ secrets.OCI_API_KEY }}
          pass-phrase: ${{ secrets.OCI_PASSPHRASE }}
          region: ${{ secrets.OCI_REGION }}
          tenancy: ${{ secrets.OCI_TENANCY }}

      - name: Setup kubectl
        uses: azure/setup-kubectl@v3

      - name: Configure kubectl
        run: |
          oci ce cluster create-kubeconfig \
            --cluster-id ${{ secrets.OCI_CLUSTER_ID }} \
            --region ${{ secrets.OCI_REGION }} \
            --file $HOME/.kube/config

      - name: Set image tag
        id: tag
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ] && [ -n "${{ github.event.inputs.version }}" ]; then
            echo "tag=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "tag=develop-$(echo ${{ github.sha }} | cut -c1-7)" >> $GITHUB_OUTPUT

      - name: Deploy
        run: |
          cd ${{ env.HELM_CHART_PATH }}
          helm upgrade --install ${{ env.SERVICE_NAME }} . \
            --namespace ${{ env.STAGING_NAMESPACE }} \
            --create-namespace \
            --set image.repository=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }} \
            --set image.tag=${{ steps.tag.outputs.tag }} \
            --values values-staging.yaml \
            --wait \
            --timeout 10m

      - name: Verify
        run: |
          kubectl rollout status deployment/${{ env.SERVICE_NAME }}-deployment \
            -n ${{ env.STAGING_NAMESPACE }} \
            --timeout=5m

      - name: Health check
        run: |
          SERVICE_URL="http://${{ env.SERVICE_NAME }}.${{ env.STAGING_NAMESPACE }}.svc.cluster.local:${{ env.SERVICE_PORT }}"
          kubectl run curl-test --image=curlimages/curl:latest --rm -i --restart=Never \
            --namespace ${{ env.STAGING_NAMESPACE }} \
            -- curl -f $SERVICE_URL/health || exit 1

  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'production')
    environment:
      name: production
      url: https://api.example.com

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure OCI CLI
        uses: oracle-actions/setup-oci-cli@v1
        with:
          config-file-content: ${{ secrets.OCI_CONFIG }}
          fingerprint: ${{ secrets.OCI_FINGERPRINT }}
          apikey: ${{ secrets.OCI_API_KEY }}
          pass-phrase: ${{ secrets.OCI_PASSPHRASE }}
          region: ${{ secrets.OCI_REGION }}
          tenancy: ${{ secrets.OCI_TENANCY }}

      - name: Setup kubectl
        uses: azure/setup-kubectl@v3

      - name: Configure kubectl
        run: |
          oci ce cluster create-kubeconfig \
            --cluster-id ${{ secrets.OCI_CLUSTER_ID }} \
            --region ${{ secrets.OCI_REGION }} \
            --file $HOME/.kube/config

      - name: Set image tag
        id: tag
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ] && [ -n "${{ github.event.inputs.version }}" ]; then
            echo "tag=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "tag=main-$(echo ${{ github.sha }} | cut -c1-7)" >> $GITHUB_OUTPUT

      - name: Deploy
        run: |
          cd ${{ env.HELM_CHART_PATH }}
          helm upgrade --install ${{ env.SERVICE_NAME }} . \
            --namespace ${{ env.PRODUCTION_NAMESPACE }} \
            --create-namespace \
            --set image.repository=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }} \
            --set image.tag=${{ steps.tag.outputs.tag }} \
            --values values-prod.yaml \
            --wait \
            --timeout 15m

      - name: Verify
        run: |
          kubectl rollout status deployment/${{ env.SERVICE_NAME }}-deployment \
            -n ${{ env.PRODUCTION_NAMESPACE }} \
            --timeout=10m

      - name: Health check
        run: |
          SERVICE_URL="http://${{ env.SERVICE_NAME }}.${{ env.PRODUCTION_NAMESPACE }}.svc.cluster.local:${{ env.SERVICE_PORT }}"
          kubectl run curl-test --image=curlimages/curl:latest --rm -i --restart=Never \
            --namespace ${{ env.PRODUCTION_NAMESPACE }} \
            -- curl -f $SERVICE_URL/health || exit 1
          kubectl run curl-test --image=curlimages/curl:latest --rm -i --restart=Never \
            --namespace ${{ env.PRODUCTION_NAMESPACE }} \
            -- curl -f $SERVICE_URL/ready || exit 1

      - name: Notify
        if: always()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          text: 'Shipping Service production deployment ${{ job.status }}'
          webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}

